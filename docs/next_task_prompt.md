## 明日工作：加速分析與系統改造實作計畫（延伸版）

根據今日對「如何讓條款分析在10秒內完成」的深入討論，整理以下結論與具體執行步驟，作為明日重點工作：

---

### ✅ 結論與詳細說明

1. **單靠 GPT 分析全部條款，時間成本過高**：

   * 若每條條款平均需 2～3 秒分析時間，30 條即需 1.5 分鐘以上。
   * 若系統還要處理 API 排程、網路延遲、並行限制，整體分析時間可達 5～30 分鐘甚至更久。
   * 使用者體感不佳，等待過久會降低使用意願。

2. **本地規則初篩 + GPT 精選分析 是可行的加速解法**：

   * 使用 Python 撰寫的關鍵字或句型比對（如「免責」、「不負責」、「可隨時終止」等）可瞬間判定 80～90% 條款是否安全。
   * 這樣只需將可能有風險的條款送 GPT，減少 API 負載。
   * 快速分析只需 1～2 秒，即可提供「初步風險」結果。

3. **分析模式切換（快速 / 精準）提供不同用戶選擇**：

   * 一般消費者適合快速分析，重視速度與便利。
   * 法務、內控、企業用戶需要精準分析，願意花時間取得詳細理由。
   * 讓使用者能根據需求自行選擇模式，是符合實務需求的彈性設計。

4. **非同步分析 + 查詢頁 + 通知機制 能避免使用者等待焦慮**：

   * 精準分析可放入背景任務執行，不堵塞主流程。
   * 分析完成後透過 Email 或專屬查詢頁通知使用者。
   * 即使用戶關掉網頁，也能回來查詢結果，流程不中斷。

---

### 🛠 明日實作任務清單（詳細說明）

#### 🔹 1. 實作「快速分析」邏輯（本地初篩）

* 在 `core/risk_analyzer.py` 中新增函式 `local_rule_filter(clause: str) -> bool`：

  * 內部比對高風險關鍵字，例如「免責」、「不負責」、「隨時終止」、「不可抗力」、「不得爭議」等
  * 傳入一條條款文字，若命中風險詞則回傳 `True`，否則回傳 `False`
* 在 `analyze_clause()` 中加入判斷：

  * 若模式為快速模式（mode=fast），則先執行 `local_rule_filter()`
  * 若無風險則直接標示為「一般資訊」，略過 GPT
  * 若命中風險，標記為「可能風險」，但也不送 GPT，只是警示

#### 🔹 2. 新增「分析模式」切換機制（前端 + 後端）

* 在 `extension/content.js` 中新增 UI 控制元件（radio button 或 dropdown）：

  * 「快速分析（預設）」
  * 「精準分析」
* 前端呼叫 `/analyze` API 時，將 mode 加入 POST 內容：

  ```json
  { "clauses": ["...", "..."], "mode": "fast" }
  ```
* 在 `tools/api_server.py` 的分析端點中：

  * 根據 mode 判斷要使用本地規則或送 GPT
  * 若為精準分析，可繼續執行原本邏輯

#### 🔹 3. 精準分析模式中新增「部分分析」選項

* 在 UI 上新增一個文字區塊讓用戶貼上需分析條文
* 當使用者選擇「只分析部分條文」選項時：

  * 僅送這段文字到後端 API 處理
  * 可以直接用 `/analyze` 單欄位呼叫，省去大量系統負擔

#### 🔹 4. 支援非同步任務處理（精準分析）

* 在 `api_server.py` 中設計任務提交邏輯：

  * 接收到分析請求後立即產生 task\_id（UUID）並回傳
  * 背景執行實際分析流程，可使用 `ThreadPoolExecutor` 或 `Celery`
  * 分析完成後輸出結果至 `outputs/pending_results/<task_id>.json`

#### 🔹 5. 建立分析結果查詢頁（回查入口）

* 在前端建立一個查詢頁，路由設為 `/result/<task_id>`
* 用戶點入後前端自動呼叫 `/get_result?task_id=...` 從後端撈資料
* 若該任務尚未完成，顯示「分析中」與自動重新整理（每5秒）
* 若已完成，顯示完整風險結果清單

#### 🔹 6. 撰寫 Email 通知模板與觸發邏輯

* 當後端分析任務結束時，觸發 Email 通知功能：

  * 使用 `Flask-Mail` 或 SendGrid API
  * 信件內容包含「您的分析已完成」與連結按鈕
* 提醒內容可如下：

  > 您提交的精準分析任務已完成。點擊下方按鈕查看分析結果：
  > [查看結果](https://tool.com/result/abc123)

---

### 🧩 附加建議（後續優化）

* 建立條款快取比對：使用條款文字產生 SHA256 hash，如已分析過則直接重用結果
* UI 勾選功能：快速分析後每條旁邊加 checkbox，可挑選特定條款送 GPT 分析
* 分析結果頁提供「複製 JSON」「下載報告」「轉寄」等功能

---

這份工作清單與說明為明日的主軸，目標是讓系統能真正支援「10 秒內有結果」、「中長時間可查詢」、「風險控制可調整」的高彈性合約分析體驗。如需展開其中任何一項，我可立即協助開發原型。
