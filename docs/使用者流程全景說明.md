# AI 合約條款風險分析工具 - 使用者流程全景說明

本文件說明本工具從原始合約資料到分析與測試的完整流程，供開發與維運參考。

---

## 🧭 流程階段概觀

### **階段一：合約條文擷取與前處理**

| 步驟      | 說明                                                             |
| ------- | -------------------------------------------------------------- |
| 條文來源    | `.docx`, `.txt`, `.pdf` 等合約檔案，存放於 `assets/clause examples/` 目錄 |
| 清理與語言判斷 | 透過 `core/clean_text.py` 和 `core/lang_detect.py` 處理             |
| 結果輸出    | 可進一步餵入測試或分析流程                                                  |

---

### **階段二：GPT 條款分析階段**

| 步驟       | 說明                                                                                   |
| -------- | ------------------------------------------------------------------------------------ |
| 分析模組     | 使用 `core/risk_analyzer.py` 模組，搭配 `prompt_template_zh.txt` 或 `prompt_template_en.txt` |
| 輸入內容     | 條文文字（支援中英文）                                                                          |
| GPT 輸出欄位 | `risk_level`, `type`, `reason`（風險等級、風險類型、理由）                                         |
| 快取機制     | 所有分析結果會快取至 `tests/results_cache.json`，以避免重複查詢                                        |

---

### **階段三：測資製作與格式一致化**

| 步驟     | 說明                                                                   |
| ------ | -------------------------------------------------------------------- |
| 白名單檔案  | `data/whitelist_examples.json`                                       |
| 黑名單檔案  | `data/risk_examples.json`                                            |
| 欄位格式統一 | 所有條文需包含：`clause`, `risk_level`, `type`, `reason`, `language`, `tags` |
| 工具支援   | `tools/fix_whitelist_format.py`, `tools/fix_risk_format.py`          |

---

### **階段四：測試驗證與快取使用**

| 步驟     | 說明                                                               |
| ------ | ---------------------------------------------------------------- |
| 測試主程式  | `tests/test_risk_cases_runner_dual.py`                           |
| 支援功能   | 分析黑白名單條文，與預期 `risk_level`／`type` 進行比對                            |
| 快取運作   | 使用 `results_cache.json` 自動讀寫已分析過的條文（以 `clause + language` 為 key） |
| CLI 參數 |                                                                  |

* `--no-cache`：忽略快取，強制重送 GPT
* `--limit N`：限制分析前 N 筆資料（黑白名單各 N 筆）
* `--check-type`（開發中）：比對 GPT 與原始資料中的 `type` 欄位是否一致
  \| 執行範例 | `python tests/test_risk_cases_runner_dual.py --limit 10` |

---

### **階段五：分析結果彙整與視覺化**

| 步驟              | 說明                                                   |
| --------------- | ---------------------------------------------------- |
| 統一輸出格式          | 分析結果輸出為 JSON（如 `outputs/zh_sample_test_output.json`） |
| 報表呈現            | 結果可匯入 `report_template.html` 呈現風險標記、類型、語言、原始條文等資訊    |
| Summary 概覽（開發中） | 預計新增 CLI `--summary`：顯示資料中語言分布、風險等級分布與類型比例等          |

---

## 📁 關鍵模組與資料對照表

| 功能          | 模組 / 檔案                                                     |
| ----------- | ----------------------------------------------------------- |
| 條文清理與語言判斷   | `core/clean_text.py`, `lang_detect.py`                      |
| GPT 分析主程式   | `core/risk_analyzer.py`                                     |
| 測資來源（白／黑名單） | `data/whitelist_examples.json`, `data/risk_examples.json`   |
| 測試工具        | `tests/test_risk_cases_runner_dual.py`                      |
| 測試快取儲存      | `tests/results_cache.json`                                  |
| 格式修正工具      | `tools/fix_whitelist_format.py`, `tools/fix_risk_format.py` |
| 報表模板        | `report_template.html`                                      |

---

此流程文件會隨版本演進持續更新，請依照目前 CLI 與模組版本執行，以確保結果準確一致。
